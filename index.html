<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Spending Memos</title>
    <!-- React and ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Kalam:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .font-handwriting { font-family: 'Kalam', cursive; }
        .lined-paper {
            background-image: linear-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 100% 3rem;
            line-height: 3rem;
        }
        body { overscroll-behavior-y: contain; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        
        // Robust Icon Component for Browser Mode
        const Icon = ({ name, className = "w-6 h-6" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                    iconRef.current.innerHTML = '';
                    const iconData = window.lucide.icons[name];
                    if (iconData) {
                        const svgElement = window.lucide.createElement(iconData);
                        const classes = className.split(' ');
                        classes.forEach(cls => { if (cls) svgElement.classList.add(cls); });
                        svgElement.setAttribute('width', '24');
                        svgElement.setAttribute('height', '24');
                        iconRef.current.appendChild(svgElement);
                    }
                }
            }, [name, className]);
            return <span ref={iconRef} className="inline-flex items-center justify-center"></span>;
        };

        const App = () => {
            const [view, setView] = useState('today'); 
            const [expenses, setExpenses] = useState(() => {
                const saved = localStorage.getItem('student_expenses_v2');
                return saved ? JSON.parse(saved) : {};
            });
            const [currency, setCurrency] = useState(() => {
                return localStorage.getItem('student_currency') || '$';
            });
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [showSettings, setShowSettings] = useState(false);
            const [expandedMonth, setExpandedMonth] = useState(null);
            
            const [isAdding, setIsAdding] = useState(false);
            const [step, setStep] = useState('name');
            const [tempName, setTempName] = useState('');
            const [tempPrice, setTempPrice] = useState('');

            const [editingId, setEditingId] = useState(null);
            const [editName, setEditName] = useState('');
            const [editPrice, setEditPrice] = useState('');

            const todayStr = new Date().toISOString().split('T')[0];
            const currentMonthStr = todayStr.substring(0, 7);

            const currencies = [
                { symbol: '$', name: 'USD' }, { symbol: '£', name: 'GBP' },
                { symbol: '€', name: 'EUR' }, { symbol: '₹', name: 'INR' },
                { symbol: '¥', name: 'JPY' }, { symbol: '₩', name: 'KRW' },
            ];

            useEffect(() => {
                localStorage.setItem('student_expenses_v2', JSON.stringify(expenses));
            }, [expenses]);

            useEffect(() => {
                localStorage.setItem('student_currency', currency);
            }, [currency]);

            // Restoration of Export Functionality
            const exportData = () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(expenses, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", `memos_backup_${todayStr}.json`);
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            };

            const clearAllData = () => {
                if (window.confirm("Are you sure? This will delete all your memos permanently.")) {
                    setExpenses({});
                    setShowSettings(false);
                }
            };

            const handleAddClick = () => {
                setIsAdding(true);
                setStep('name');
                setEditingId(null);
            };

            const submitName = (e) => {
                if (e.key === 'Enter' && tempName.trim()) setStep('price');
            };

            const submitPrice = (e) => {
                if (e.key === 'Enter' && tempPrice) {
                    const newEntry = { id: Date.now(), name: tempName, price: parseFloat(tempPrice) || 0 };
                    setExpenses(prev => ({ ...prev, [selectedDate]: [...(prev[selectedDate] || []), newEntry] }));
                    setTempName(''); setTempPrice(''); setIsAdding(false); setStep('name');
                }
            };

            const startEditing = (item) => {
                setEditingId(item.id);
                setEditName(item.name);
                setEditPrice(item.price.toString());
                setIsAdding(false);
            };

            const saveEdit = () => {
                if (!editName.trim()) return;
                setExpenses(prev => ({
                    ...prev,
                    [selectedDate]: prev[selectedDate].map(item => 
                        item.id === editingId ? { ...item, name: editName, price: parseFloat(editPrice) || 0 } : item
                    )
                }));
                setEditingId(null);
            };

            const deleteExpense = (id) => {
                setExpenses(prev => ({ ...prev, [selectedDate]: prev[selectedDate].filter(item => item.id !== id) }));
            };

            const getTotalForDate = (date) => (expenses[date] || []).reduce((sum, item) => sum + item.price, 0);

            const historyGroups = useMemo(() => {
                const sortedDates = Object.keys(expenses).sort().reverse();
                const currentMonthDates = sortedDates.filter(d => d.startsWith(currentMonthStr));
                const olderDates = sortedDates.filter(d => !d.startsWith(currentMonthStr));
                const olderGroups = olderDates.reduce((acc, date) => {
                    const month = date.substring(0, 7);
                    if (!acc[month]) acc[month] = [];
                    acc[month].push(date);
                    return acc;
                }, {});
                return { currentMonthDates, olderGroups };
            }, [expenses, currentMonthStr]);

            const Header = ({ title, showBack = false }) => (
                <div className="flex items-center justify-between p-6 bg-[#fffdf5] border-b border-gray-200 sticky top-0 z-20">
                    <div className="flex items-center gap-3">
                        {showBack && (
                            <button onClick={() => setView('today')} className="p-1">
                                <Icon name="ChevronLeft" className="w-6 h-6 text-gray-600" />
                            </button>
                        )}
                        <h1 className="text-2xl font-handwriting font-bold text-gray-800 tracking-tight">{title}</h1>
                    </div>
                    <div className="flex gap-4">
                        <button onClick={() => setView('stats')} className={view === 'stats' ? 'text-amber-600' : 'text-gray-400'}><Icon name="BarChart3" /></button>
                        <button onClick={() => setView('history')} className={view === 'history' ? 'text-amber-600' : 'text-gray-400'}><Icon name="Calendar" /></button>
                        <button onClick={() => setShowSettings(true)} className="text-gray-400"><Icon name="Settings" /></button>
                    </div>
                </div>
            );

            return (
                <div className="max-w-md mx-auto min-h-screen bg-[#fffdf5] font-sans text-gray-900 shadow-xl overflow-x-hidden relative">
                    {/* Updated Settings with Export */}
                    {showSettings && (
                        <div className="fixed inset-0 z-50 bg-black/20 backdrop-blur-sm flex items-center justify-center p-6">
                            <div className="bg-white w-full max-w-xs rounded-3xl shadow-2xl overflow-hidden">
                                <div className="bg-amber-50 p-6 flex justify-between items-center border-b border-amber-100">
                                    <h3 className="font-handwriting text-2xl font-bold text-gray-800">Settings</h3>
                                    <button onClick={() => setShowSettings(false)} className="text-gray-400"><Icon name="X" /></button>
                                </div>
                                <div className="p-6 space-y-6">
                                    <div>
                                        <label className="text-[10px] font-bold text-gray-400 uppercase tracking-widest block mb-3">Currency</label>
                                        <div className="grid grid-cols-3 gap-2">
                                            {currencies.map((curr) => (
                                                <button key={curr.symbol} onClick={() => setCurrency(curr.symbol)} className={`h-10 rounded-xl font-handwriting text-lg border-2 ${currency === curr.symbol ? 'border-amber-400 bg-amber-50 text-amber-700' : 'border-gray-100 text-gray-400'}`}>{curr.symbol}</button>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="pt-4 border-t border-gray-100 space-y-3">
                                        <button onClick={exportData} className="w-full flex items-center justify-between p-3 bg-blue-50 text-blue-700 rounded-xl font-bold text-sm">
                                            <span>Export Backup (.json)</span>
                                            <Icon name="Download" className="w-4 h-4" />
                                        </button>
                                        <button onClick={clearAllData} className="w-full flex items-center justify-between p-3 bg-red-50 text-red-600 rounded-xl font-bold text-sm">
                                            <span>Clear All Records</span>
                                            <Icon name="Trash2" className="w-4 h-4" />
                                        </button>
                                    </div>
                                </div>
                                <div className="p-4 bg-gray-50 text-center">
                                    <button onClick={() => setShowSettings(false)} className="font-handwriting text-amber-600 text-lg font-bold">Back to Memos</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {view === 'today' && <Header title="My Spending Memos" />}
                    {view === 'history' && <Header title="Journal History" showBack />}
                    {view === 'stats' && <Header title="Spending Stats" showBack />}

                    <main className="pb-32">
                        {view === 'today' && (
                            <div className="p-6">
                                <div className="flex justify-between items-end mb-8">
                                    <div>
                                        <h2 className="text-3xl font-handwriting text-gray-800">{selectedDate === todayStr ? "Today's Notes" : new Date(selectedDate).toLocaleDateString()}</h2>
                                        <div className="h-1 w-20 bg-amber-400 rounded-full mt-1"></div>
                                    </div>
                                    <div className="text-right">
                                        <span className="text-xs font-bold text-gray-400 uppercase block">Total</span>
                                        <span className="text-2xl font-handwriting font-bold text-amber-600">{currency}{getTotalForDate(selectedDate).toFixed(2)}</span>
                                    </div>
                                </div>

                                <div className="lined-paper min-h-[400px]">
                                    {(expenses[selectedDate] || []).map((item, idx) => (
                                        <div key={item.id} className="flex justify-between items-center border-b border-gray-100 px-2 h-[3rem]">
                                            {editingId === item.id ? (
                                                <div className="flex items-center gap-2 flex-1 h-full py-1">
                                                    <input autoFocus className="bg-amber-50 font-handwriting text-xl outline-none text-gray-700 w-1/2 px-1 rounded h-full" value={editName} onChange={(e) => setEditName(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && saveEdit()} />
                                                    <div className="flex items-center"><span className="font-handwriting text-xl text-amber-600 mr-1">{currency}</span><input type="number" className="bg-amber-50 font-handwriting text-xl outline-none text-amber-600 w-20 px-1 rounded h-full" value={editPrice} onChange={(e) => setEditPrice(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && saveEdit()} /></div>
                                                    <button onClick={saveEdit} className="text-green-500 p-1"><Icon name="Check" className="w-5 h-5" /></button>
                                                    <button onClick={() => setEditingId(null)} className="text-gray-300 p-1"><Icon name="X" className="w-4 h-4" /></button>
                                                </div>
                                            ) : (
                                                <>
                                                    <div className="flex items-center gap-4 truncate cursor-pointer flex-1 h-full" onClick={() => startEditing(item)}>
                                                        <span className="text-gray-400 font-handwriting text-xl">{idx + 1}.</span>
                                                        <span className="font-handwriting text-xl text-gray-700 truncate">{item.name}</span>
                                                    </div>
                                                    <div className="flex items-center gap-4">
                                                        <span className="font-handwriting text-xl text-gray-900 font-bold cursor-pointer" onClick={() => startEditing(item)}>{currency}{item.price.toFixed(2)}</span>
                                                        <button onClick={() => deleteExpense(item.id)} className="text-red-300 hover:text-red-500 p-1"><Icon name="Trash2" className="w-4 h-4" /></button>
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                    ))}
                                    {!isAdding ? (
                                        <div className="h-[3rem] flex items-center px-2">
                                            <button onClick={handleAddClick} className="flex items-center gap-2 text-amber-500 font-handwriting text-xl"><Icon name="Plus" className="w-5 h-5" /> <span>Add entry...</span></button>
                                        </div>
                                    ) : (
                                        <div className="h-[3rem] flex justify-between items-center px-2 bg-amber-50/50">
                                            <div className="flex items-center gap-4 flex-1">
                                                <span className="text-amber-400 font-handwriting text-xl">{(expenses[selectedDate]?.length || 0) + 1}.</span>
                                                {step === 'name' ? (
                                                    <input autoFocus className="bg-transparent font-handwriting text-xl outline-none text-gray-700 w-full" placeholder="Type name..." value={tempName} onChange={(e) => setTempName(e.target.value)} onKeyDown={submitName} />
                                                ) : (
                                                    <div className="flex items-center gap-4 w-full">
                                                        <span className="font-handwriting text-xl text-gray-700" onClick={() => setStep('name')}>{tempName}</span>
                                                        <div className="flex items-center"><span className="font-handwriting text-xl text-amber-600 mr-1">{currency}</span><input autoFocus type="number" className="bg-transparent font-handwriting text-xl outline-none text-amber-600 w-24 border-b border-amber-300" value={tempPrice} onChange={(e) => setTempPrice(e.target.value)} onKeyDown={submitPrice} /></div>
                                                    </div>
                                                )}
                                            </div>
                                            <button onClick={() => setIsAdding(false)} className="text-gray-300"><Icon name="X" /></button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                        {view === 'history' && (
                            <div className="p-6 space-y-10">
                                <div>
                                    <h3 className="font-handwriting text-xl text-amber-600 mb-4 border-b border-amber-100 flex items-center gap-2">
                                        <Icon name="Calendar" className="w-5 h-5" /> This Month
                                    </h3>
                                    <div className="grid gap-4">
                                        {historyGroups.currentMonthDates.map(date => (
                                            <div key={date} onClick={() => { setSelectedDate(date); setView('today'); }} className="bg-[#fef3c7] shadow-md p-4 rotate-1 border-b-2 border-r-2 border-amber-200 cursor-pointer active:scale-95">
                                                <p className="font-handwriting text-gray-500 text-sm">{new Date(date).toLocaleDateString('en-US', { weekday: 'short', day: 'numeric', month: 'short' })}</p>
                                                <div className="flex justify-between items-center mt-1">
                                                    <span className="font-handwriting text-lg font-bold text-gray-700">{(expenses[date] || []).length} items</span>
                                                    <span className="font-handwriting text-xl text-amber-600 font-bold">{currency}{getTotalForDate(date).toFixed(2)}</span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {Object.keys(historyGroups.olderGroups).length > 0 && (
                                    <div className="pt-4">
                                        <h3 className="font-handwriting text-xl text-gray-400 mb-4 flex items-center gap-2 italic">
                                            <Icon name="Archive" className="w-5 h-5" /> Archived Memos
                                        </h3>
                                        <div className="space-y-3">
                                            {Object.entries(historyGroups.olderGroups).map(([month, dates]) => {
                                                const isExpanded = expandedMonth === month;
                                                const monthTotal = dates.reduce((sum, d) => sum + getTotalForDate(d), 0);
                                                const monthLabel = new Date(month + '-01').toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                                                return (
                                                    <div key={month} className="bg-white rounded-2xl border border-gray-100 overflow-hidden shadow-sm">
                                                        <button onClick={() => setExpandedMonth(isExpanded ? null : month)} className="w-full flex justify-between items-center p-4">
                                                            <div>
                                                                <span className="font-handwriting text-lg text-gray-700">{monthLabel}</span>
                                                                <span className="ml-3 text-xs bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full font-bold">{dates.length} days</span>
                                                            </div>
                                                            <div className="flex items-center gap-3">
                                                                <span className="font-handwriting font-bold text-gray-400">{currency}{monthTotal.toFixed(2)}</span>
                                                                <Icon name={isExpanded ? "ChevronUp" : "ChevronDown"} className="w-4 h-4 text-gray-300" />
                                                            </div>
                                                        </button>
                                                        {isExpanded && (
                                                            <div className="bg-gray-50 p-3 grid gap-2 border-t border-gray-50">
                                                                {dates.map(date => (
                                                                    <div key={date} onClick={() => { setSelectedDate(date); setView('today'); }} className="bg-white p-3 rounded-xl flex justify-between items-center shadow-sm border border-gray-100 active:bg-amber-50">
                                                                        <span className="font-handwriting text-gray-600">{new Date(date).toLocaleDateString('en-US', { day: 'numeric', month: 'short' })}</span>
                                                                        <span className="font-handwriting font-bold text-amber-600">{currency}{getTotalForDate(date).toFixed(2)}</span>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                        {view === 'stats' && (
                            <div className="p-6">
                                <h2 className="font-handwriting text-2xl mb-6">Analysis</h2>
                                {Object.entries(Object.keys(expenses).reduce((acc, d) => { const m = d.substring(0,7); acc[m] = (acc[m]||0) + getTotalForDate(d); return acc; }, {})).sort().reverse().map(([month, total]) => (
                                    <div key={month} className="border-l-4 border-amber-400 pl-4 py-2 mb-4 bg-white/40">
                                        <p className="text-gray-400 text-xs uppercase font-bold">{new Date(month + '-01').toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</p>
                                        <p className="font-handwriting text-3xl text-gray-800 font-bold">{currency}{total.toFixed(2)}</p>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>

                    <nav className="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white/80 backdrop-blur-md border-t border-gray-100 flex justify-around p-4 z-10">
                        <button onClick={() => { setSelectedDate(todayStr); setView('today'); }} className={`flex flex-col items-center gap-1 ${view === 'today' ? 'text-amber-600' : 'text-gray-400'}`}><Icon name="Plus" /><span className="text-[10px] font-bold uppercase tracking-wider">Write</span></button>
                        <button onClick={() => setView('history')} className={`flex flex-col items-center gap-1 ${view === 'history' ? 'text-amber-600' : 'text-gray-400'}`}><Icon name="Calendar" /><span className="text-[10px] font-bold uppercase tracking-wider">Journal</span></button>
                        <button onClick={() => setView('stats')} className={`flex flex-col items-center gap-1 ${view === 'stats' ? 'text-amber-600' : 'text-gray-400'}`}><Icon name="BarChart3" /><span className="text-[10px] font-bold uppercase tracking-wider">Stats</span></button>
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
